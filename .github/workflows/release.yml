name: Build Feather IPA

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up keychain (optional for signing)
      run: |
        security create-keychain -p "" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "" build.keychain
        security set-keychain-settings

    - name: Clean and build project
      run: |
        xcodebuild clean \
          -workspace Feather.xcworkspace \
          -scheme Feather \
          -configuration Release

        xcodebuild archive \
          -workspace Feather.xcworkspace \
          -scheme Feather \
          -configuration Release \
          -archivePath $PWD/build/Feather.xcarchive \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath $PWD/build/Feather.xcarchive \
          -exportOptionsPlist ExportOptions.plist \
          -exportPath $PWD/build/export

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: Feather-ipa
        path: build/export/*.ipa
